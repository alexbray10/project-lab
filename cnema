#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>
#include <conio.h>

#define MAX_MOVIES 300
#define MAX_SHOWS 20
#define MAX_TITLE 200
#define MAX_LINE 512
#define MAX_FNB 300
#define MAX_USERS 1000
#define SEAT_ROWS 9
#define SEAT_COLS 12

typedef struct {
    int id;
    char title[MAX_TITLE];
    char showtimes[MAX_SHOWS][16];
    int showCount;
    int price;
} Movie;

typedef struct {
    int id;
    char name[128];
    int price;
} FNBItem;

typedef struct {
    char username[128];
    char fullname[128];
    char password[128];
} User;

Movie movies[MAX_MOVIES];
int movieCount = 0;

FNBItem fnbs[MAX_FNB];
int fnbCount = 0;

User users[MAX_USERS];
int userCount = 0;

char sessionUsername[128] = "";
char sessionFullname[128] = "";
int sessionIsAdmin = 0;

void flushStdin(void) {
    int c;
    while ((c = getchar()) != '\n' && c != EOF) {}
}

void trimNewline(char *s) {
    if (!s) return;
    size_t L = strlen(s);
    while (L > 0 && (s[L-1] == '\n' || s[L-1] == '\r')) {
        s[L-1] = '\0';
        L--;
    }
}

void trimSpaces(char *s) {
    if (!s) return;
    char *p = s;
    while (*p && isspace((unsigned char)*p)) p++;
    if (p != s) memmove(s, p, strlen(p) + 1);
    int len = (int)strlen(s);
    while (len > 0 && isspace((unsigned char)s[len-1])) s[--len] = '\0';
}

void clearScreen(void) {
    system("cls || clear");
}

void pauseConsole(void) {
    printf("\nPress ENTER to continue...");
    flushStdin();
}

void getPasswordMasked(char *buf, int bufsize) {
    if (!buf || bufsize <= 0) return;
    int idx = 0;
    buf[0] = '\0';
    while (1) {
        int ch = getch();
        if (ch == '\n' || ch == '\r' || ch == 10 || ch == 13) {
            putchar('\n');
            break;
        }
        if (ch == 127 || ch == 8) {
            if (idx > 0) {
                idx--;
                buf[idx] = '\0';
                printf("\b \b");
            }
        } else if (ch == 3) {
            exit(0);
        } else if (isprint((unsigned char)ch) && idx < bufsize - 1) {
            buf[idx++] = (char)ch;
            buf[idx] = '\0';
            putchar('*');
        }
    }
}

void loadMovies(const char *moviesFile) {
    movieCount = 0;
    FILE *f = fopen(moviesFile, "r");
    if (!f) return;
    char line[MAX_LINE];
    while (fgets(line, sizeof(line), f)) {
        trimNewline(line);
        trimSpaces(line);
        if (strlen(line) == 0) continue;
        Movie m;
        char shows[256] = "";
        int matched = sscanf(line, "%d|%199[^|]|%255[^|]|%d", &m.id, m.title, shows, &m.price);
        if (matched >= 2) {
            if (matched == 2) {
                m.price = 0;
                shows[0] = '\0';
            }
            trimSpaces(m.title);
            trimSpaces(shows);
            m.showCount = 0;
            if (strlen(shows) > 0) {
                char temp[256];
                strncpy(temp, shows, sizeof(temp) - 1);
                temp[sizeof(temp) - 1] = '\0';
                char *t = strtok(temp, ",");
                while (t && m.showCount < MAX_SHOWS) {
                    trimSpaces(t);
                    strncpy(m.showtimes[m.showCount], t, 15);
                    m.showtimes[m.showCount][15] = '\0';
                    m.showCount++;
                    t = strtok(NULL, ",");
                }
            }
            movies[movieCount++] = m;
            if (movieCount >= MAX_MOVIES) break;
        }
    }
    fclose(f);
}

void loadFnbs(const char *fnbFile) {
    fnbCount = 0;
    FILE *f = fopen(fnbFile, "r");
    if (!f) return;
    char line[MAX_LINE];
    while (fgets(line, sizeof(line), f)) {
        trimNewline(line);
        trimSpaces(line);
        if (strlen(line) == 0) continue;
        FNBItem it;
        int matched = sscanf(line, "%d|%127[^|]|%d", &it.id, it.name, &it.price);
        if (matched >= 2) {
            if (matched == 2) it.price = 0;
            trimSpaces(it.name);
            fnbs[fnbCount++] = it;
            if (fnbCount >= MAX_FNB) break;
        }
    }
    fclose(f);
}

void loadUsersFromFile(const char *usersFile) {
    userCount = 0;
    FILE *f = fopen(usersFile, "r");
    if (!f) return;
    char line[MAX_LINE];
    while (fgets(line, sizeof(line), f)) {
        trimNewline(line);
        trimSpaces(line);
        if (strlen(line) == 0) continue;
        char uname[128], pass[128], fullname[128];
        int matched = sscanf(line, "%127[^|]|%127[^|]|%127[^|]", uname, pass, fullname);
        if (matched >= 2) {
            trimSpaces(uname);
            trimSpaces(pass);
            trimSpaces(fullname);
            strncpy(users[userCount].username, uname, sizeof(users[userCount].username) - 1);
            users[userCount].username[sizeof(users[userCount].username) - 1] = '\0';
            strncpy(users[userCount].password, pass, sizeof(users[userCount].password) - 1);
            users[userCount].password[sizeof(users[userCount].password) - 1] = '\0';
            strncpy(users[userCount].fullname, fullname, sizeof(users[userCount].fullname) - 1);
            users[userCount].fullname[sizeof(users[userCount].fullname) - 1] = '\0';
            userCount++;
            if (userCount >= MAX_USERS) break;
        }
    }
    fclose(f);
}

int saveUserToFile(const char *usersFile, const char *username, const char *password, const char *fullname) {
    FILE *f = fopen(usersFile, "a");
    if (!f) return 0;
    fprintf(f, "%s|%s|%s\n", username, password, fullname);
    fclose(f);
    return 1;
}

void seatFilename(int movieID, int showIndex, char *out, size_t outsz) {
    snprintf(out, outsz, "seats_%d_%d.txt", movieID, showIndex);
}

void ensureSeatFile(int movieID, int showIndex) {
    char fname[256];
    seatFilename(movieID, showIndex, fname, sizeof(fname));
    FILE *f = fopen(fname, "r");
    if (f) {
        fclose(f);
        return;
    }
    f = fopen(fname, "w");
    if (!f) return;
    for (int r = 0; r < SEAT_ROWS; r++) {
        for (int c = 0; c < SEAT_COLS; c++) {
            fprintf(f, "0");
            if (c < SEAT_COLS - 1) fprintf(f, " ");
        }
        fprintf(f, "\n");
    }
    fclose(f);
}

int loadSeats(int movieID, int showIndex, int seats[SEAT_ROWS][SEAT_COLS]) {
    char fname[256];
    seatFilename(movieID, showIndex, fname, sizeof(fname));
    FILE *f = fopen(fname, "r");
    if (!f) {
        ensureSeatFile(movieID, showIndex);
        for (int r = 0; r < SEAT_ROWS; r++) {
            for (int c = 0; c < SEAT_COLS; c++) seats[r][c] = 0;
        }
        return 0;
    }
    for (int r = 0; r < SEAT_ROWS; r++) {
        for (int c = 0; c < SEAT_COLS; c++) {
            int v = 0;
            if (fscanf(f, "%d", &v) == 1) seats[r][c] = (v ? 1 : 0);
            else seats[r][c] = 0;
        }
    }
    fclose(f);
    return 0;
}

int saveSeats(int movieID, int showIndex, int seats[SEAT_ROWS][SEAT_COLS]) {
    char fname[256];
    seatFilename(movieID, showIndex, fname, sizeof(fname));
    FILE *f = fopen(fname, "w");
    if (!f) return -1;
    for (int r = 0; r < SEAT_ROWS; r++) {
        for (int c = 0; c < SEAT_COLS; c++) {
            fprintf(f, "%d", seats[r][c] ? 1 : 0);
            if (c < SEAT_COLS - 1) fprintf(f, " ");
        }
        fprintf(f, "\n");
    }
    fclose(f);
    return 0;
}

void displaySeatGrid(int seats[SEAT_ROWS][SEAT_COLS]) {
    printf("\n     ");
    for (int c = 1; c <= SEAT_COLS; ++c) printf(" %2d ", c);
    printf("\n");
    for (int r = 0; r < SEAT_ROWS; ++r) {
        char rowc = 'A' + r;
        printf(" %c    ", rowc);
        for (int c = 0; c < SEAT_COLS; ++c) {
            if (seats[r][c] == 0) printf("[ ] ");
            else printf("[X] ");
        }
        printf("\n");
    }
    printf("\n             		SCREEN\n\n");
}

int validShowtimeFormat(const char *s) {
    if (!s) return 0;
    int len = (int)strlen(s);
    if (len < 4 || len > 5) return 0;
    const char *p = strchr(s, ':');
    if (!p) return 0;
    int pre = (int)(p - s);
    int post = len - pre - 1;
    if (pre < 1 || pre > 2 || post != 2) return 0;
    for (int i = 0; i < pre; i++) {
        if (!isdigit((unsigned char)s[i])) return 0;
    }
    for (int i = pre + 1; i < len; i++) {
        if (!isdigit((unsigned char)s[i])) return 0;
    }
    return 1;
}

int titleIsValid(const char *s) {
    if (!s) return 0;
    int L = (int)strlen(s);
    if (L == 0) return 0;
    int allDigit = 1;
    for (int i = 0; i < L; i++) {
        if (!isdigit((unsigned char)s[i])) {
            allDigit = 0;
            break;
        }
    }
    if (allDigit) return 0;
    return 1;
}

void appendTransactionLog(const char *line) {
    FILE *f = fopen("transactions.txt", "a");
    if (!f) return;
    fprintf(f, "%s\n", line);
    fclose(f);
}

typedef struct {
    char name[128];
    int qty;
    int price;
} OrderItem;

int ciStrcmp(const char *a, const char *b) {
    while (*a && *b) {
        char ca = tolower((unsigned char)*a);
        char cb = tolower((unsigned char)*b);
        if (ca != cb) return (int)(ca - cb);
        a++; b++;
    }
    return (int)(tolower((unsigned char)*a) - tolower((unsigned char)*b));
}

int orderItemCmp(const void *pa, const void *pb) {
    const OrderItem *a = (const OrderItem*)pa;
    const OrderItem *b = (const OrderItem*)pb;
    return ciStrcmp(a->name, b->name);
}

void printFnbReceipt(OrderItem items[], int count) {
    if (count <= 0) {
        printf("\nNo F&B ordered.\n");
        return;
    }
    OrderItem *copy = malloc(sizeof(OrderItem) * count);
    if (!copy) {
        printf("\nF&B Items (unsorted):\n");
        for (int i = 0; i < count; i++) {
            printf("- %s x%d = Rp %d\n", items[i].name, items[i].qty, items[i].qty * items[i].price);
        }
        return;
    }
    for (int i = 0; i < count; i++) copy[i] = items[i];
    qsort(copy, count, sizeof(OrderItem), orderItemCmp);

    printf("\n====== STRUK F&B (sorted ascending) ======\n");
    int subtotal = 0;
    for (int i = 0; i < count; i++) {
        int lineTotal = copy[i].qty * copy[i].price;
        printf("%-30s x%3d   Rp %8d\n", copy[i].name, copy[i].qty, lineTotal);
        subtotal += lineTotal;
    }
    printf("-----------------------------------------\n");
    printf("F&B Subtotal: Rp %d\n", subtotal);
    printf("=========================================\n");

    free(copy);
}

void adminAddMovie(const char *moviesFile) {
    loadMovies(moviesFile);
    Movie m;
    int nextID = 1;
    for (int i = 0; i < movieCount; i++) {
        if (movies[i].id >= nextID) nextID = movies[i].id + 1;
    }
    m.id = nextID;

    printf("Enter movie title: ");
    if (!fgets(m.title, sizeof(m.title), stdin)) {
		printf("Input error\n");
		return;
	}
    trimNewline(m.title); trimSpaces(m.title);

    if (!titleIsValid(m.title)) { printf("Invalid title (empty or numeric-only). Aborted.\n"); return; }

    printf("Enter showtimes (comma separated, e.g. 12:00,15:00): ");
    char sline[512];
    if (!fgets(sline, sizeof(sline), stdin)) {
		printf("Input error\n");
		return;
	}
    trimNewline(sline); trimSpaces(sline);

    if (strlen(sline) == 0) {
		printf("No showtimes provided. Aborted.\n");
		return;
	}

    char temp[512];
    strncpy(temp, sline, sizeof(temp) - 1);
    temp[sizeof(temp) - 1] = '\0';
    m.showCount = 0;
    char *tok = strtok(temp, ",");
    while (tok && m.showCount < MAX_SHOWS) {
        trimSpaces(tok);
        if (!validShowtimeFormat(tok)) {
			printf("Invalid showtime format: %s. Aborted.\n", tok);
			return;
		}
        strncpy(m.showtimes[m.showCount], tok, 15); m.showtimes[m.showCount][15] = '\0';
        m.showCount++;
        tok = strtok(NULL, ",");
    }
    if (m.showCount == 0) { printf("No valid showtimes. Aborted.\n"); return; }

    printf("Enter price (numeric, >0): ");
    if (scanf("%d", &m.price) != 1) { flushStdin(); printf("Invalid price input. Aborted.\n"); return; }
    flushStdin();
    if (m.price <= 0) { printf("Price must be > 0. Aborted.\n"); return; }

    FILE *fw = fopen(moviesFile, "a");
    if (!fw) { printf("Cannot open movies file to append.\n"); return; }
    char showbuf[512] = "";
    for (int i = 0; i < m.showCount; i++) {
        if (i) strcat(showbuf, ",");
        strcat(showbuf, m.showtimes[i]);
    }
    fprintf(fw, "%d|%s|%s|%d\n", m.id, m.title, showbuf, m.price);
    fclose(fw);

    for (int i = 0; i < m.showCount; i++) ensureSeatFile(m.id, i);

    printf("Movie added with ID %d\n", m.id);
}

void bookingFlow(const char *moviesFile, const char *fnbFile) {
    loadMovies(moviesFile);
    if (movieCount == 0) {
		printf("No movies available.\n");
		pauseConsole();
		return;
	}

    printf("\n=== Movies ===\n");
    for (int i = 0; i < movieCount; i++) {
        printf("ID:%d | %s | Rp %d | Shows: ", movies[i].id, movies[i].title, movies[i].price);
        for (int j = 0; j < movies[i].showCount; j++) {
            printf("%s", movies[i].showtimes[j]);
            if (j < movies[i].showCount-1) printf(", ");
        }
        printf("\n");
    }
    printf("Enter movie ID to book: ");
    int mid;
    if (scanf("%d", &mid) != 1) {
		flushStdin();
		printf("Invalid\n");
		return;
	}
    flushStdin();
    int idx = -1;
    for (int i = 0; i < movieCount; i++) {
        if (movies[i].id == mid) {
			idx = i;
			break;
		}
    }
    if (idx == -1) {
		printf("Movie not found\n");
		pauseConsole();
		return;
	}
    Movie *m = &movies[idx];
    if (m->showCount == 0) {
        printf("No showtimes\n");
        pauseConsole();
        return;
    }

    printf("Select showtime:\n");
    for (int i = 0; i < m->showCount; i++) {
        printf("%d. %s\n", i+1, m->showtimes[i]);
    }
    printf("Choose (1-%d): ", m->showCount);
    int schoice;
    if (scanf("%d", &schoice) != 1) {
		flushStdin();
		printf("Invalid\n");
		return;
	}
    flushStdin();
    if (schoice < 1 || schoice > m->showCount) {
		printf("Invalid showtime\n");
		pauseConsole();
		return;
	}
    int showIndex = schoice - 1;
    char chosenShow[16];
    strncpy(chosenShow, m->showtimes[showIndex], 15); chosenShow[15] = '\0';

    int seats[SEAT_ROWS][SEAT_COLS];
    ensureSeatFile(m->id, showIndex);
    loadSeats(m->id, showIndex, seats);

    printf("How many tickets to buy? ");
    int qty;
    if (scanf("%d", &qty) != 1) {
		flushStdin();
		printf("Invalid\n");
		return;
	}
    flushStdin();
    if (qty <= 0) {
		printf("Invalid qty\n");
		pauseConsole();
		return;
	}

    int avail = 0;
    for (int r = 0; r < SEAT_ROWS; r++) {
        for (int c = 0; c < SEAT_COLS; c++) {
            if (seats[r][c] == 0) avail++;
        }
    }
    if (qty > avail) {
        printf("Not enough seats available (%d left)\n", avail);
        pauseConsole();
        return;
    }

    char chosenSeats[200][8];
    int chosenCount = 0;

    while (chosenCount < qty) {
        clearScreen();
        printf("Movie: %s | Showtime: %s\n", m->title, chosenShow);
        printf("Select seats (%d remaining):\n", qty - chosenCount);
        displaySeatGrid(seats);
        printf("Enter seat code (e.g. B7): ");
        char input[32];
        if (!fgets(input, sizeof(input), stdin)) continue;
        trimNewline(input); trimSpaces(input);
        if (strlen(input) < 2) {
            printf("Invalid input\n");
            pauseConsole();
            continue;
        }
        char rowc = toupper(input[0]);
        if (rowc < 'A' || rowc > 'A' + SEAT_ROWS - 1) {
			printf("Row out of range\n");
			pauseConsole();
			continue;
		}
        int row = rowc - 'A';
        int col = atoi(input+1) - 1;
        if (col < 0 || col >= SEAT_COLS) {
			printf("Column out of range\n");
			pauseConsole();
			continue;
		}
        if (seats[row][col] == 1) {
			printf("Seat %c%d already occupied\n", rowc, col+1);
			pauseConsole();
			continue;
		}
        seats[row][col] = 1;
        sprintf(chosenSeats[chosenCount], "%c%d", rowc, col+1);
        chosenCount++;
        printf("Seat %c%d reserved temporarily.\n", rowc, col+1);
        pauseConsole();
    }

    int ticketSubtotal = chosenCount * m->price;
    printf("\n=== Payment Summary (Ticket) ===\n");
    printf("Movie: %s\nShowtime: %s\n", m->title, chosenShow);
    printf("Seats: ");
    for (int i = 0; i < chosenCount; i++) {
        if (i) printf(", ");
        printf("%s", chosenSeats[i]);
    }
    printf("\nTicket price each: Rp %d\nTicket subtotal: Rp %d\n", m->price, ticketSubtotal);
    printf("\nPress ENTER to continue to payment method...");
    flushStdin();
    getchar();

    printf("\nChoose payment method: 1. Cash  2. Card\nChoice: ");
    int payChoice = 1;
    if (scanf("%d", &payChoice) != 1) {
		flushStdin();
		payChoice = 1;
	}
    flushStdin();
    char payMethod[64] = "Cash";
    if (payChoice == 2) {
        strcpy(payMethod, "Card");
        char card[64];
        printf("Enter card number (simulated): ");
        if (fgets(card, sizeof(card), stdin)) {
            trimNewline(card);
			trimSpaces(card);
        }
    }

    printf("\n=== Payment Successful ===\n");
    printf("Ticket subtotal: Rp %d\nPayment method: %s\n", ticketSubtotal, payMethod);
    printf("\nPress ENTER to proceed to F&B ordering (optional)...");
    getchar();

    clearScreen();

    loadFnbs(fnbFile);
    char orderedNames[100][128];
    int qtys[100], prices[100];
    int ordCount = 0;

    if (fnbCount == 0) {
        printf("No F&B menu available. Press ENTER to see final summary...");
        getchar();
    } else {
        while (1) {
            clearScreen();
            printf("=== F&B Menu ===\n");
            for (int i = 0; i < fnbCount; i++) {
            	printf("%d. %s - Rp %d\n", fnbs[i].id, fnbs[i].name, fnbs[i].price);
			}
            printf("\nYour current F&B order (%d items):\n", ordCount);
            if (ordCount == 0) {
                printf("  (none)\n");
            } else {
                for (int i = 0; i < ordCount; i++) {
                    printf("  %d) %s x%d = Rp %d\n", i+1, orderedNames[i], qtys[i], qtys[i]*prices[i]);
                }
            }
            printf("\nOptions:\n");
            printf("1. Add Item\n");
            printf("2. Review/Edit Current Order\n");
            printf("0. Done / Finish F&B ordering\n");
            printf("Enter choice: ");
            int menuChoice;
            if (scanf("%d", &menuChoice) != 1) { flushStdin(); printf("Invalid\n"); pauseConsole(); continue; }
            flushStdin();
            if (menuChoice == 0) break;
            else if (menuChoice == 1) {
                printf("Enter item ID (as shown above): ");
                int id;
                if (scanf("%d", &id) != 1) { flushStdin(); printf("Invalid\n"); pauseConsole(); continue; }
                flushStdin();
                int find = -1;
                for (int i = 0; i < fnbCount; i++) {
                    if (fnbs[i].id == id) { find = i; break; }
                }
                if (find == -1) { printf("Item not found\n"); pauseConsole(); continue; }
                printf("Quantity: ");
                int q;
                if (scanf("%d", &q) != 1) { flushStdin(); printf("Invalid\n"); pauseConsole(); continue; }
                flushStdin();
                if (q <= 0) { printf("Invalid qty\n"); pauseConsole(); continue; }
                if (ordCount < 100) {
                    strncpy(orderedNames[ordCount], fnbs[find].name, 127);
                    qtys[ordCount] = q;
                    prices[ordCount] = fnbs[find].price;
                    ordCount++;
                    printf("Added %s x%d\n", fnbs[find].name, q);
                } else {
                    printf("Order list full\n");
                }
                printf("Press ENTER to continue ordering...");
                getchar();
            } else if (menuChoice == 2) {
                if (ordCount == 0) {
					printf("No items to edit. Press ENTER...");
					getchar();
					continue;
				}
                while (1) {
                    clearScreen();
                    printf("=== Review / Edit Order ===\n");
                    for (int i = 0; i < ordCount; i++) {
                        printf("%d) %s x%d = Rp %d\n", i+1, orderedNames[i], qtys[i], qtys[i]*prices[i]);
                    }
                    printf("0) Back to F&B menu\n");
                    printf("Select item number to edit (0 back): ");
                    int sel;
                    if (scanf("%d", &sel) != 1) {
						flushStdin();
						printf("Invalid\n");
						pauseConsole();
						continue;
					}
                    flushStdin();
                    if (sel == 0) break;
                    if (sel < 1 || sel > ordCount) {
						printf("Invalid selection\n");
						pauseConsole();
						continue;
					}
                    int idxItem = sel - 1;
                    
                    while (1) {
                        clearScreen();
                        printf("Editing: %s x%d = Rp %d\n", orderedNames[idxItem], qtys[idxItem], qtys[idxItem]*prices[idxItem]);
                        printf("1. Change quantity\n");
                        printf("2. Replace with another F&B item\n");
                        printf("3. Delete this item\n");
                        printf("0. Back\n");
                        printf("Choose action: ");
                        int act;
                        if (scanf("%d", &act) != 1) {
							flushStdin();
							printf("Invalid\n");
							pauseConsole();
							continue;
						}
                        flushStdin();
                        if (act == 0) break;
                        else if (act == 1) {
                            printf("Enter new quantity (0 to delete): ");
                            int nq;
                            if (scanf("%d", &nq) != 1) {
								flushStdin();
								printf("Invalid\n");
								pauseConsole();
								continue;
							}
                            flushStdin();
                            if (nq < 0) {
								printf("Invalid qty\n");
								pauseConsole();
								continue;
							}
                            if (nq == 0) {
                                for (int k = idxItem; k < ordCount - 1; k++) {
                                    strcpy(orderedNames[k], orderedNames[k+1]);
                                    qtys[k] = qtys[k+1];
                                    prices[k] = prices[k+1];
                                }
                                ordCount--;
                                printf("Item deleted.\n");
                                pauseConsole();
                                break;
                            } else {
                                qtys[idxItem] = nq;
                                printf("Quantity updated.\n");
                                pauseConsole();
                            }
                        } else if (act == 2) {
                            clearScreen();
                            printf("F&B Items available:\n");
                            for (int i = 0; i < fnbCount; i++) {
                            	printf("%d. %s - Rp %d\n", fnbs[i].id, fnbs[i].name, fnbs[i].price);
							}
                            printf("Enter new item ID to replace with: ");
                            int newid;
                            if (scanf("%d", &newid) != 1) {
								flushStdin();
								printf("Invalid\n");
								pauseConsole();
								continue;
							}
                            flushStdin();
                            int find2 = -1;
                            for (int i = 0; i < fnbCount; i++) {
                            	if (fnbs[i].id == newid) {
									find2 = i;
									break;
								}
							}
                            if (find2 == -1) {
								printf("Item not found\n");
								pauseConsole();
								continue;
							}
                            strncpy(orderedNames[idxItem], fnbs[find2].name, 127);
                            prices[idxItem] = fnbs[find2].price;
                            printf("Item replaced.\n");
                            pauseConsole();
                        } else if (act == 3) {
                            for (int k = idxItem; k < ordCount - 1; k++) {
                                strcpy(orderedNames[k], orderedNames[k+1]);
                                qtys[k] = qtys[k+1];
                                prices[k] = prices[k+1];
                            }
                            ordCount--;
                            printf("Item deleted.\n");
                            pauseConsole();
                            break;
                        } else {
                            printf("Invalid action\n"); pauseConsole();
                        }
                    }
                }
            } else {
                printf("Invalid option\n"); pauseConsole();
            }
        }
    }

    OrderItem items[100];
    for (int i = 0; i < ordCount; i++) {
        strncpy(items[i].name, orderedNames[i], sizeof(items[i].name)-1);
        items[i].name[sizeof(items[i].name)-1] = '\0';
        items[i].qty = qtys[i];
        items[i].price = prices[i];
    }

    printFnbReceipt(items, ordCount);

    printf("\nPress ENTER to continue to final summary...");
    getchar();

    int fnbSubtotal = 0;
    for (int i = 0; i < ordCount; i++) fnbSubtotal += qtys[i] * prices[i];
    int grandTotal = ticketSubtotal + fnbSubtotal;

    clearScreen();
    printf("\n===== FINAL SUMMARY =====\n");
    printf("Name        : %s\n", sessionFullname[0] ? sessionFullname : "Guest");
    printf("Movie       : %s\n", m->title);
    printf("Showtime    : %s\n", chosenShow);
    printf("Seats       : ");
    for (int i = 0; i < chosenCount; i++) {
		if (i) printf(", ");
		printf("%s", chosenSeats[i]);
	}
    printf("\nTicket price: Rp %d\nTicket qty  : %d\nTicket total: Rp %d\n", m->price, chosenCount, ticketSubtotal);
    if (ordCount > 0) {
        printf("\nF&B Items (unsorted in summary view):\n");
        for (int i = 0; i < ordCount; i++) {
        	printf("- %s x%d = Rp %d\n", orderedNames[i], qtys[i], qtys[i]*prices[i]);
		}
    } else {
        printf("\nNo F&B ordered.\n");
    }
    printf("\nGrand Total : Rp %d\n", grandTotal);
    printf("Payment method: %s\n", payMethod);
    printf("\nThank you for booking with \"C\"nema!\n");
    printf("================================\n");

    if (saveSeats(m->id, showIndex, seats) != 0) printf("Warning: failed to save seats file.\n");

    {
        FILE *tf = fopen("transactions.txt", "a");
        if (tf) {
            time_t t = time(NULL);
            struct tm tm = *localtime(&t);
            char timestr[64];
            sprintf(timestr, "%04d-%02d-%02d %02d:%02d:%02d",
                    tm.tm_year+1900, tm.tm_mon+1, tm.tm_mday, tm.tm_hour, tm.tm_min, tm.tm_sec);
            fprintf(tf, "[%s] user:%s | movie:%s | show:%s | seats:", timestr,
                    sessionUsername[0] ? sessionUsername : "guest", m->title, chosenShow);
            for (int i = 0; i < chosenCount; i++) {
                if (i) fprintf(tf, ",");
                fprintf(tf, "%s", chosenSeats[i]);
            }
            fprintf(tf, " | ticket:%d | ticket_total:%d | fnb_total:%d | grand_total:%d | payment:%s\n",
                    chosenCount, ticketSubtotal, fnbSubtotal, grandTotal, payMethod);

            if (ordCount > 0) {
                OrderItem *copy = malloc(sizeof(OrderItem) * ordCount);
                if (copy) {
                    for (int i = 0; i < ordCount; i++) copy[i] = items[i];
                    qsort(copy, ordCount, sizeof(OrderItem), orderItemCmp);
                    fprintf(tf, "    FNB items (sorted): ");
                    for (int i = 0; i < ordCount; i++) {
                        fprintf(tf, "%s x%d", copy[i].name, copy[i].qty);
                        if (i < ordCount-1) fprintf(tf, "; ");
                    }
                    fprintf(tf, "\n");
                    free(copy);
                } else {
                    fprintf(tf, "    FNB items: ");
                    for (int i = 0; i < ordCount; i++) {
                        fprintf(tf, "%s x%d", items[i].name, items[i].qty);
                        if (i < ordCount-1) fprintf(tf, "; ");
                    }
                    fprintf(tf, "\n");
                }
            }
            fclose(tf);
        } else {
            printf("Warning: cannot open transactions.txt to append.\n");
        }
    }
    printf("\nPress ENTER to return to main menu...");
    getchar();
}

int loginRegisterFlow(const char *usersFile) {
    loadUsersFromFile(usersFile);

    while (1) {
        clearScreen();
        printf("=== Welcome to \"C\"nema ===\n");
        printf("1. Login\n2. Register\n3. Exit\nChoice: ");
        int ch;
        if (scanf("%d", &ch) != 1) {
			flushStdin();
			continue;
		}
        flushStdin();
        if (ch == 1) {
            char uname[128], pass[128];
            printf("Username (email or 'admin'): ");
            if (!fgets(uname, sizeof(uname), stdin)) continue;
            trimNewline(uname); trimSpaces(uname);
            printf("Password: ");
            getPasswordMasked(pass, sizeof(pass)); trimNewline(pass); trimSpaces(pass);

            if ((strcmp(uname, "admin") == 0 || strcmp(uname, "admin@gmail.com") == 0) && strcmp(pass, "admin1234") == 0) {
                strcpy(sessionUsername, "admin");
                strcpy(sessionFullname, "Administrator");
                sessionIsAdmin = 1;
                return 1;
            }

            loadUsersFromFile(usersFile);
            int found = 0;
            for (int i = 0; i < userCount; i++) {
                if (strcmp(users[i].username, uname) == 0 && strcmp(users[i].password, pass) == 0) {
                    strcpy(sessionUsername, users[i].username);
                    strcpy(sessionFullname, users[i].fullname);
                    sessionIsAdmin = 0;
                    found = 1; break;
                }
            }
            if (found) return 1;
            printf("Invalid username or password. Press ENTER to continue...");
            getchar();
        } else if (ch == 2) {
            char fullname[128], uname[128], p1[128], p2[128];
            printf("Full name: ");
            if (!fgets(fullname, sizeof(fullname), stdin)) continue;
            trimNewline(fullname); trimSpaces(fullname);
            while (1) {
                printf("Username (must end with @gmail.com): ");
                if (!fgets(uname, sizeof(uname), stdin)) break;
                trimNewline(uname); trimSpaces(uname);
                int L = (int)strlen(uname);
                if (L <= 10 || strcmp(uname + L - 10, "@gmail.com") != 0) {
					printf("Must end with @gmail.com\n");
					continue;
				}

                loadUsersFromFile(usersFile);
                int exists = 0;
                for (int i = 0; i < userCount; i++) if (strcmp(users[i].username, uname) == 0) {
					exists = 1;
					break;
				}
                if (exists) {
					printf("Username already used\n");
					continue;
				}
                break;
            }
            while (1) {
                printf("Password: ");
                getPasswordMasked(p1, sizeof(p1)); trimNewline(p1); trimSpaces(p1);
                printf("Confirm password: ");
                getPasswordMasked(p2, sizeof(p2)); trimNewline(p2); trimSpaces(p2);
                if (strcmp(p1, p2) != 0) {
					printf("Passwords do not match\n");
					continue;
				}
                break;
            }

            if (!saveUserToFile(usersFile, uname, p1, fullname)) {
                printf("Failed to save user to file. Press ENTER...");
                getchar();
            } else {
                loadUsersFromFile(usersFile);
                printf("Registration successful. You may now login. Press ENTER...");
                getchar();
            }
        } else if (ch == 3) {
            return 0;
        } else {
            printf("Invalid choice\n"); pauseConsole();
        }
    }
}

void adminMenu(const char *moviesFile, const char *fnbFile, const char *usersFile) {
    while (1) {
        clearScreen();
        printf("=== ADMIN MENU ===\n");
        printf("1. Add Movie\n2. View Movies\n3. View F&B\n4. Logout\nChoice: ");
        int ch;
        if (scanf("%d", &ch) != 1) {
			flushStdin();
			continue;
		}
        flushStdin();
        if (ch == 1) {
            adminAddMovie(moviesFile);
            pauseConsole();
        } else if (ch == 2) {
            loadMovies(moviesFile);
            printf("\n=== Movies ===\n");
            for (int i = 0; i < movieCount; i++) {
                printf("ID:%d | %s | Rp %d | Shows: ", movies[i].id, movies[i].title, movies[i].price);
                for (int j = 0; j < movies[i].showCount; j++) {
                    printf("%s", movies[i].showtimes[j]);
                    if (j < movies[i].showCount-1) printf(", ");
                }
                printf("\n");
            }
            pauseConsole();
        } else if (ch == 3) {
            loadFnbs(fnbFile);
            printf("\n=== F&B ===\n");
            for (int i = 0; i < fnbCount; i++) printf("%d. %s - Rp %d\n", fnbs[i].id, fnbs[i].name, fnbs[i].price);
            pauseConsole();
        } else if (ch == 4) {
            strcpy(sessionUsername, "");
			strcpy(sessionFullname, "");
			sessionIsAdmin = 0;
            break;
        } else {
            printf("Invalid\n"); pauseConsole();
        }
    }
}

int main(void) {
    const char *moviesFile = "movies.txt";
    const char *fnbFile = "fnb.txt";
    const char *usersFile = "users.txt";

    FILE *tf = fopen("transactions.txt", "a");
    if (tf) fclose(tf);

    FILE *uf = fopen(usersFile, "r");
    int hasAdmin = 0;
    if (uf) {
        char line[MAX_LINE];
        while (fgets(line, sizeof(line), uf)) {
            if (strstr(line, "admin|") != NULL) {
				hasAdmin = 1;
				break;
			}
        }
        fclose(uf);
    }
    if (!hasAdmin) {
        FILE *wf = fopen(usersFile, "a");
        if (wf) {
            fprintf(wf, "admin|admin1234|Administrator\n");
            fclose(wf);
        }
    }
    loadUsersFromFile(usersFile);

    while (1) {
        if (!loginRegisterFlow(usersFile)) break;
        if (sessionIsAdmin) {
            adminMenu(moviesFile, fnbFile, usersFile);
        } else {
            while (1) {
                clearScreen();
                printf("=== USER MENU ===\n");
                printf("Logged in as: %s (%s)\n", sessionFullname, sessionUsername);
                printf("1. Book Ticket\n2. Logout\nChoice: ");
                int ch;
                if (scanf("%d", &ch) != 1) {
					flushStdin();
					continue;
				}
                flushStdin();
                if (ch == 1) {
                    bookingFlow(moviesFile, fnbFile);
                } else if (ch == 2) {
                    strcpy(sessionUsername, "");
					strcpy(sessionFullname, "");
					sessionIsAdmin = 0;
                    break;
                } else {
                    printf("Invalid\n");
					pauseConsole();
                }
            }
        }
    }
    printf("Goodbye!\n");
    return 0;
}
