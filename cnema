#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>
#include <conio.h>

#define BARIS 9
#define KOLOM 12
#define FILM 100
#define FNB 100
#define USER 1000
#define JAM 10

typedef struct{
    int id;
    char title[1000];
    char showTimes[100][100];
    int showCount;
    int price;
} Movie;

typedef struct{
    int id;
    char name[100];
    int price;
} MenuFNB;

typedef struct{
    char username[100];
    char fullname[100];
    char password[100];
} User;

void clearScreen(){
    system("cls || clear");
}

void clearInput(){
    int a;
    while ((a = getchar()) != '\n' && a != EOF) {}
}

void pauseScreen(){
    printf("Press Enter to continue...");
    clearInput();
}

void readLine(char *buf, int size) {
    if (!buf || size <= 0) return;
    if (fgets(buf, size, stdin) == NULL) {
        buf[0] = '\0';
        return;
    }
    buf[strcspn(buf, "\r\n")] = '\0';
}

void getPasswordMasked(char *buf, int bufsize) {
    if (!buf || bufsize <= 0) return;
    int idx = 0;
    buf[0] = '\0';
    while (1) {
        int ch = getch();
        if (ch == 13 || ch == 10) {
            putchar('\n');
            break;
        } else if (ch == 8 || ch == 127) {
            if (idx > 0) {
                idx--;
                buf[idx] = '\0';
                printf("\b \b");
            }
        } else if (isprint((unsigned char)ch) && idx < bufsize - 1) {
            buf[idx++] = (char)ch;
            buf[idx] = '\0';
            putchar('*');
        }
    }
}

int isValidEmail(const char *email) {
    if (!email) return 0;
    size_t len = strlen(email);
    if (len == 0) return 0;

    for (size_t i = 0; i < len; ++i) {
        if (isspace((unsigned char)email[i])) return 0;
    }

    const char *at = strchr(email, '@');
    if (!at) return 0;
    if (at == email) return 0;
    if (strchr(at + 1, '@') != NULL) return 0;

    const char *suffix = "@gmail.com";
    size_t sfxLen = strlen(suffix);
    if (len <= sfxLen) return 0;
    if (strcmp(email + len - sfxLen, suffix) != 0) return 0;

    return 1;
}

User users[USER];
int userCount = 0;
int currentUser = -1;

void loadUsers(){
    FILE *f = fopen("users.txt", "r");
    if (!f) {
        userCount = 0;
        return;
    }

    userCount = 0;
    char line[512];
    while (userCount < USER && fgets(line, sizeof(line), f)) {
        line[strcspn(line, "\r\n")] = '\0';
        char uname[100], fname[100], pass[100];
        int matched = sscanf(line, "%99[^|]|%99[^|]|%99[^\n]", uname, fname, pass);
        if (matched == 3) {
            strncpy(users[userCount].username, uname, sizeof(users[userCount].username)-1);
            users[userCount].username[sizeof(users[userCount].username)-1] = '\0';
            strncpy(users[userCount].fullname, fname, sizeof(users[userCount].fullname)-1);
            users[userCount].fullname[sizeof(users[userCount].fullname)-1] = '\0';
            strncpy(users[userCount].password, pass, sizeof(users[userCount].password)-1);
            users[userCount].password[sizeof(users[userCount].password)-1] = '\0';
            userCount++;
        } else {

            continue;
        }
    }
    fclose(f);
}

void saveUser(User acc){
    FILE *f = fopen("users.txt", "a");
    if (!f) return;
    fprintf(f, "%s|%s|%s\n", acc.username, acc.fullname, acc.password);
    fclose(f);
}

void registerPage(){
    clearScreen();
    printf("=-=-= Register Account =-=-=\n");
    User acc;
    char p1[100], p2[100];

    while (1) {
        printf("Full Name: ");
        readLine(acc.fullname, sizeof(acc.fullname));
        if (strlen(acc.fullname) == 0) {
            printf("Full name cannot be empty.\n");
            continue;
        }
        break;
    }

    while (1) {
        printf("Email (@gmail.com): ");
        readLine(acc.username, sizeof(acc.username));
        if (!isValidEmail(acc.username)) {
            printf("Email must end with @gmail.com and be valid.\n");
            continue;
        }
        int exists = 0;
        for (int i = 0; i < userCount; ++i) {
            if (strcmp(acc.username, users[i].username) == 0) { exists = 1; break; }
        }
        if (exists) {
            printf("Username already used. Try another.\n");
            continue;
        }
        break;
    }

    while (1) {
        printf("Password: ");
        getPasswordMasked(p1, sizeof(p1));
        printf("Confirm password: ");
        getPasswordMasked(p2, sizeof(p2));
        if (strcmp(p1, p2) != 0) {
            printf("Passwords do not match. Try again.\n");
            continue;
        }
        if (strlen(p1) == 0) {
            printf("Password cannot be empty.\n");
            continue;
        }
        strncpy(acc.password, p1, sizeof(acc.password)-1);
        acc.password[sizeof(acc.password)-1] = '\0';
        break;
    }

    saveUser(acc);
    loadUsers();

    printf("\nAccount created successfully!\n");
    pauseScreen();
}

int loginPage(){
    clearScreen();
    printf("=-=-= Login =-=-=\n");
    char username[100], password[100];

    printf("Username (@gmail.com): ");
    readLine(username, sizeof(username));

    printf("Password: ");
    getPasswordMasked(password, sizeof(password));

    for (int i = 0; i < userCount; ++i){
        if (strcmp(username, users[i].username) == 0 && strcmp(password, users[i].password) == 0){
            printf("\nLogin Successful! Welcome, %s\n", users[i].fullname);
            currentUser = i;
            pauseScreen();
            return 1;
        }
    }

    printf("\nInvalid username or password.\n");
    pauseScreen();
    return 0;
}

void userMenu() {
    while (currentUser >= 0) {
        clearScreen();
        printf("=== USER MENU ===\n");
        printf("Logged in as: %s (%s)\n", users[currentUser].fullname, users[currentUser].username);
        printf("1. Book Ticket  (placeholder)\n");
        printf("2. Logout\n");
        printf("Choice: ");
        int ch;
        if (scanf("%d", &ch) != 1) {
            clearInput();
            continue;
        }
        clearInput();
        if (ch == 1) {
            printf("Booking flow not implemented yet. (will add next parts)\n");
            pauseScreen();
        } else if (ch == 2) {
            currentUser = -1;
            printf("Logged out.\n");
            pauseScreen();
            break;
        } else {
            printf("Invalid choice.\n");
            pauseScreen();
        }
    }
}

void ensureAdminUser(void) {
    FILE *uf = fopen("users.txt", "r");
    int hasAdmin = 0;
    if (uf) {
        char line[512];
        while (fgets(line, sizeof(line), uf)) {
            if (strncmp(line, "admin|", 6) == 0) { hasAdmin = 1; break; }
        }
        fclose(uf);
    }
    if (!hasAdmin) {
        FILE *wf = fopen("users.txt", "a");
        if (!wf) return;
        fprintf(wf, "admin|Administrator|admin1234\n");
        fclose(wf);
    }
}

int main(void) {
    ensureAdminUser();
    loadUsers();

    while (1) {
        clearScreen();
        printf("=-=-= Welcome to Cnema! =-=-=\n");
        printf("1. Login\n");
        printf("2. Register\n");
        printf("3. Exit\n");
        printf("Choice: ");

        int n;
        if (scanf("%d", &n) != 1) {
            clearInput();
            continue;
        }
        clearInput();

        if (n == 1) {
            if (loginPage()) {
                userMenu();
            }
        } else if (n == 2) {
            registerPage();
        } else if (n == 3) {
            printf("Goodbye!\n");
            break;
        } else {
            printf("Invalid.\n");
            pauseScreen();
        }
    }
    return 0;
}
